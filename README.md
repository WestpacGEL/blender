# Blender [![CircleCI](https://circleci.com/gh/WestpacGEL/blender/tree/master.svg?style=svg)](https://circleci.com/gh/WestpacGEL/blender/tree/master)

## Scripts

| name                | description                                                                               |
| ------------------- | ----------------------------------------------------------------------------------------- |
| `build`             | Building the source files and moving them into `lib/` and `bin/` folder                   |
| `build:lib`         | Building all lib files. Changing these files won't break symlinks created with `npm link` |
| `build:bin`         | Moving the `bin.js` file from `lib/` to `bin/` and renaming it to `index.js`              |
| `watch`             | Watching all files inside `src/` for changes and running `build:lib` if detected          |
| `format`            | Format all code with prettier                                                             |
| `test`              | Run all tests                                                                             |
| `test:format`       | Testing for code style differences                                                        |
| `test:unit`         | Run all unit Jest tests                                                                   |
| `test:unit-watch`   | Run Jest in watch mode                                                                    |
| `test:types`        | Run all type tests                                                                        |
| `types:clean`       | Cleans all type definition files generated by `types:declaration`                         |
| `types:declaration` | Build type declaration files                                                              |
| `nuke`              | Remove all artifacts from including `node_modules` folder and lock files                  |
| `fresh`             | Run `nuke` and `yarn` in sequence                                                         |

## CLI

You can run the blender as a cli tool.
First install it via npm:

```sh
npm i -g @westpac/blender
```

Then you can run the `blender` command.

```sh
cd path/to/my/project
blender
```

The blender comes with the following settings:

```sh
blender
	-T                                    # --test
	-b WBC                                # --brand
	-o path/to                            # --output
	-c path/to/css                        # --output-css
	-j path/to/js                         # --output-js
	-h path/to/html                       # --output-html
	-t path/to/token                      # --output-token
	-f less                               # --tokens-format
	-S "@westpac"                         # --scope
	-i "@westpac/button" "@westpac/alert" # --include
	-x "@westpac/button" "@westpac/alert" # --exclude
	-D path/to/cwd                        # --cwd
	-p                                    # --prettify
	-J                                    # --exclude-jquery
	-m                                    # --modules
	-C                                    # --no-version-in-class
	-g                                    # --debug
	-v                                    # --version
	-h                                    # --help
```

An example of running the blender with all flags would be:

```sh
blender -Tb WBC --output path/to/all --output-css path/to/css --output-js path/to/js --output-html path/to/html --output-token path/to/token --scope "@westpac" --include "@westpac/button" "@westpac/core" --exclude "@westpac/tabcordion" -pJmCf less -gvh
```

_(ðŸ’¡ Note that you can combine boolean flags together: `blender -pmj` is the same as `blender -p -m -j`)_

## API

Running the tester programmatically is possible via node:

```js
const blender = require('@westopac/blender');

const result = await blender({
	cwd: 'path/to/cwd',
	test: false,
	scope: '@westpac',
	output: 'path/to/all',
	outputCss: 'path/to/css',
	outputJs: 'path/to/js',
	outputHtml: 'path/to/html',
	outputToken: 'path/to/token',
	outputZip: true,
	tokensFormat: 'less',
	include: ['@westpac/button', '@westpac/core'],
	exclude: ['@westpac/tabcordion'],
	prettify: true,
	modules: true,
	brand: 'WBC',
	excludeJquery: false,
	versionInClass: true,
});
```

## Tester

The tester checked labels created by emotion for any hashes that can't be removed.
If the tester finds labels have the same label but a different hash we can't remove the hashes easily and make the classes readable. See below example.

```
[
	"1jr47et",       // ignored cause it doesn't exists in css output
	"vctdvy-alert",
	"epbyb1-thing",  // found bug
	"7qw58u-foo",
	"x1b3bk-thing",  // because these two have same label but different hash
	"1sa041k-bar",
],
```

## Different usage

Common use cases:

```sh
blender -b WBC -o path/to/all                # get all files in the blender folder
blender -b WBC -c path/to/css                # get css only
blender -b WBC -j path/to/js                 # get js only
blender -b WBC -h path/to/html               # get html only
blender -b WBC -t path/to/tokens             # get tokens only
blender -b WBC -j path/to/js -h path/to/html # get js and css only
```

Cases where flags are ignored or missing:

```sh
blender -o path/to/out                         # error as no brand specified
blender -b WBC -o path/to/out -j path/to/js    # get only js, -o is ignored
```

## Blender support

The blender can generate human readable html and css from react and emotion components.
For this to work we require `label` attributes in our `css` prop and a couple files to blend and the `blender` key inside your `package.json`.

### getLabel

We have to add labels for every variations for props.
To archive this we have the `getLabel` function that you can import from `@westpac/core`.
Make sure you only add variations that will change CSS.
Adding more means more css classes and more html.
The best way to do this I found was to add the labels to the overrides files:

- look at the `[something]Styles` function
- copy all props from there that are being constructed
- go to the css props and insert `getLabel` with an appropriate prefix

```jsx
/** @jsx jsx */
import { jsx, getLabel } from '@westpac/core';

const Component = ({ state, ...rest }) => <div {...rest} />;

const componentStyles = (_, { dismissible, look }) => {
	//     There are two props here ----^

	const styleMap = {}; // more code here
	return {
		// The `Component-prefix` is also important to name what (sub)component this is
		label: getLabel('Component-prefix', { dismissible, look }),
		//                          ----^
		// So we add those two into the getLabel function
		padding: dismissible ? '1.125rem 1.875rem 1.125rem 1.125rem' : '1.125rem',
		// you can see here --^ how the prop changes css dynamically
		transition: 'opacity 300ms ease-in-out',
		opacity: 1,
		borderTop: '1px solid',
		borderBottom: '1px solid',
		...styleMap[look].css,
		// here too we change css dynamically with props
	};
};

const componentAttributes = () => null;

export const defaultComponent = {
	component: Component,
	styles: componentStyles,
	attributes: componentAttributes,
};
```

For the prefixes try to name so it's visible what is a parent of what.

So `getLabel('Component')` on the root component and `getLabel('Component-subcomponent')` on the sub-component will become:

```html
<div class="GEL-Component-v1_0_0-props">
	<div class="GEL-Component-v1_0_0-subcomponent-props">
		Your sub-component
	</div>
</div>
```

### Js fallback

Since the blender just SSR each component it won't provide the functionality of react and any interactivity.
For this you have to provide a `js` file for fallback.
In the GEL3 we use jQuery for this.
Each jQuery file should target elements via the `data-js` attribute since classes can vary depending on your blend settings.
So things like `data-js="body"` or `data-js="component-closebtn"` should work well and you target this via `$('[data-js="component-closebtn"]')` in jQuery.

### Core components

Inside the `package.json`

```json
"blender": {
	"recipe": "path/to/recipe.js",
	"js": "path/to/jquery-lib.js",
	"isCore": true
},
```

The `js` file should contain any framework other component rely on.
In our case that's jQuery.

The `recipe` file must export two named components `AllStyles` and `Docs`:

```jsx
import React from 'react';
import { Component } from '../src/index.js';

export function AllStyles({ brand, children }) {
	return <Component brand={brand}>{children}</Component>;
}

export function Docs({ brand }) {
	return [
		{
			heading: 'The Core Component',
			component: () => (
				<Component brand={brand}>Add your GEL components inside the Core component</Component>
			),
		},
	];
}
```

Both of these function get the `brand` object passed in and only in core `AllStyles` also get's `children` so we can remove core from the other components later.
The `Docs` component returns an array with a `heading` and a `component` key.

In short:

- The `AllStyles` component should contain all possible variations for a component
- The `Docs` component should contain everything we want to show in the documentation.

### Other components

Inside the `package.json`

```json
"blender": {
	"recipe": "blender/recipe.js",
	"js": "blender/script.js"
},
```

The `js` file is optional and only required if you have js functionality.

The `recipe` file must export two named components `AllStyles` and `Docs`:

```jsx
import { GEL } from '@westpac/core';
import React from 'react';

import { Component } from '@westpac/alert';

export function AllStyles({ brand }) {
	return (
		<GEL brand={brand}>
			<Component look="success" />
			<Component look="info" />
			<Component look="warning" />
			<Component heading="Your alert heading" />
			<Component dismissible />
		</GEL>
	);
}

export function Docs({ brand }) {
	return [
		{
			heading: 'A success alert',
			component: () => (
				<GEL brand={brand}>
					<Component look="success">Your alert body</Component>
				</GEL>
			),
		},
		{
			heading: 'A info alert',
			component: () => (
				<GEL brand={brand}>
					<Component look="info">Your alert body</Component>
				</GEL>
			),
		},
		{
			heading: 'A warning alert',
			component: () => (
				<GEL brand={brand}>
					<Component look="warning">Your alert body</Component>
				</GEL>
			),
		},
	];
}
```

Same as the core component.
